

{% block title %}All Technicians{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">All Technicians</h1>

    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-700">Technician Directory</h2>
            <a href="{{ url_for('upload_technicians') }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Upload Technicians
            </a>
        </div>
        
        <div id="loadingMessage" class="text-center text-gray-500 py-4">Loading technicians...</div>
        <div id="errorMessage" class="text-center text-red-600 py-4 hidden"></div>
        <div id="noTechniciansMessage" class="text-center text-gray-600 py-4 hidden">No technicians found.</div>

        <div class="overflow-x-auto">
            <table id="techniciansTable" class="min-w-full divide-y divide-gray-200 hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Experience</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skills</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Checks</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tools</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Technicians will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const noTechniciansMessage = document.getElementById('noTechniciansMessage');
        const techniciansTable = document.getElementById('techniciansTable');
        const tbody = techniciansTable.querySelector('tbody');

        try {
            const response = await fetch('/api/technicians');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            const technicians = data.technicians;

            loadingMessage.classList.add('hidden'); // Hide loading

            if (technicians.length === 0) {
                noTechniciansMessage.classList.remove('hidden'); // Show no technicians message
            } else {
                techniciansTable.classList.remove('hidden'); // Show table
                technicians.forEach(tech => {
                    const row = tbody.insertRow();
                    row.className = 'hover:bg-gray-50'; // Add hover effect

                    // Name
                    const nameCell = row.insertCell();
                    nameCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                    nameCell.textContent = tech.name;

                    // Contact
                    const contactCell = row.insertCell();
                    contactCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    contactCell.innerHTML = `
                        ${tech.email ? `Email: <a href="mailto:${tech.email}" class="text-blue-600 hover:underline">${tech.email}</a><br>` : ''}
                        Mobile: ${tech.mobile_phone}<br>
                        Home: ${tech.home_phone || 'N/A'}
                    `;

                    // Location
                    const locationCell = row.insertCell();
                    locationCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    locationCell.innerHTML = `
                        ${tech.address || 'N/A'}<br>
                        ${tech.city}, ${tech.state} ${tech.zip_code}<br>
                        ${tech.latitude && tech.longitude ? `Lat: ${tech.latitude.toFixed(2)}, Lon: ${tech.longitude.toFixed(2)}` : 'Coords: N/A'}
                    `;

                    // Experience
                    const experienceCell = row.insertCell();
                    experienceCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    experienceCell.textContent = `${tech.experience_years || '0'} yrs`;

                    // Skills
                    const skillsCell = row.insertCell();
                    skillsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    if (tech.skills && Object.keys(tech.skills).length > 0) {
                        skillsCell.innerHTML = Object.entries(tech.skills).map(([skill, level]) => `
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">
                                ${skill}: ${level}
                            </span>
                        `).join('');
                    } else {
                        skillsCell.textContent = 'N/A';
                    }

                    // Checks
                    const checksCell = row.insertCell();
                    checksCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    checksCell.innerHTML = `
                        ${tech.drug_screening ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Drug Screened</span>' : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">No Drug Screen</span>'}<br>
                        ${tech.background_check ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Background Checked</span>' : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">No Background Check</span>'}
                    `;
                    
                    // Tools
                    const toolsCell = row.insertCell();
                    toolsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    toolsCell.textContent = tech.tools || 'N/A';
                });
            }
        } catch (error) {
            loadingMessage.classList.add('hidden'); // Hide loading
            errorMessage.classList.remove('hidden'); // Show error
            errorMessage.textContent = `Failed to load technicians: ${error.message}`;
            console.error('Error fetching technicians:', error);
        }
    });
</script>
{% endblock %}
