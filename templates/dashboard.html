<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Post-Call Analysis Dashboard</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            background-color: #f0f2f5;

            color: #333;

            line-height: 1.6;

        }



        .container {

            max-width: 1400px;

            margin: 20px auto;

            padding: 20px;

            background-color: #fff;

            border-radius: 8px;

            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);

        }



        header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding-bottom: 20px;

            margin-bottom: 20px;

            border-bottom: 1px solid #eee;

        }



        header h1 {

            font-size: 2.2em;

            color: #2c3e50;

        }



        .kpi-grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 20px;

            margin-bottom: 30px;

        }



        .kpi-card {

            background-color: #e8f5e9; /* Light green */

            padding: 20px;

            border-radius: 8px;

            text-align: center;

            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);

            transition: transform 0.2s ease-in-out;

        }



        .kpi-card:hover {

            transform: translateY(-5px);

        }



        .kpi-card h3 {

            font-size: 1.1em;

            color: #388e3c; /* Darker green */

            margin-bottom: 10px;

        }



        .kpi-card p {

            font-size: 2em;

            font-weight: bold;

            color: #2e7d32; /* Even darker green */

        }



        .charts-section {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));

            gap: 20px;

            margin-bottom: 30px;

        }



        .chart-card {

            background-color: #fff;

            padding: 20px;

            border-radius: 8px;

            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);

            min-height: 300px; /* Ensure charts have space */

            display: flex;

            flex-direction: column;

            justify-content: space-between;

        }



        .chart-card h3 {

            text-align: center;

            color: #2c3e50;

            margin-bottom: 15px;

        }



        .calls-section {

            background-color: #fff;

            padding: 20px;

            border-radius: 8px;

            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);

        }



        .calls-section h2 {

            font-size: 1.8em;

            color: #2c3e50;

            margin-bottom: 20px;

        }



        .call-item {

            display: flex;

            justify-content: space-between;

            align-items: flex-start;

            padding: 15px 0;

            border-bottom: 1px dashed #eee;

        }



        .call-item:last-child {

            border-bottom: none;

        }



        .call-details {

            flex: 3;

        }



        .call-details h4 {

            font-size: 1.1em;

            color: #34495e;

            margin-bottom: 5px;

        }



        .call-details p {

            font-size: 0.9em;

            color: #7f8c8d;

        }



        .call-sentiment {

            flex: 1;

            text-align: right;

            font-weight: bold;

            font-size: 0.95em;

        }



        .sentiment-positive {

            color: #28a745; /* Bootstrap success green */

        }



        .sentiment-negative {

            color: #dc3545; /* Bootstrap danger red */

        }



        .sentiment-neutral {

            color: #6c757d; /* Bootstrap secondary gray */

        }



        /* Additional styles for responsiveness */

        @media (max-width: 768px) {

            .kpi-grid, .charts-section {

                grid-template-columns: 1fr;

            }

        }

    </style>

    <style>
        /* Chatbot Widget Container */
        #chatbot-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 350px; /* Adjust width as needed */
            height: 450px; /* Adjust height as needed */
            transition: all 0.3s ease-in-out;
            transform: scale(0); /* Hidden by default */
            transform-origin: bottom right;
            background-color: white;
            border: 1px solid #e0e0e0;
        }

        #chatbot-widget-container.open {
            transform: scale(1); /* Visible when open */
        }

        /* Toggle Button */
        #chatbot-toggle-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001; /* Above the widget container */
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        #chatbot-toggle-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        /* Chatbot Window Header */
        #chatbot-header {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3d8c40;
        }
        #chatbot-close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Messages Area */
        #chatbot-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f7f9fb;
            display: flex;
            flex-direction: column;
        }
        .chatbot-message {
            max-width: 80%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chatbot-message-user {
            background-color: #dcf8c6; /* Light green for user messages */
            align-self: flex-end;
            border-bottom-right-radius: 5px; /* More rounded top, flatter bottom */
        }
        .chatbot-message-ai {
            background-color: #e0e0e0; /* Light gray for AI messages */
            align-self: flex-start;
            border-bottom-left-radius: 5px; /* More rounded top, flatter bottom */
        }

        /* Input Area */
        #chatbot-input-area {
            display: flex;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
        }
        #chatbot-user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 0.9em;
            outline: none;
        }
        #chatbot-user-input:focus {
            border-color: #4CAF50;
        }
        #chatbot-send-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        #chatbot-send-button:hover {
            background-color: #45a049;
        }
    </style>
    </head>

<body>

    <div class="container">

        <header>

            <h1>Post-Call Analysis Dashboard</h1>

            </header>



        <div class="kpi-grid">

            <div class="kpi-card">

                <h3>Total Calls</h3>

                <p id="total-calls">0</p>

            </div>

            <div class="kpi-card">

                <h3>Successful Calls</h3>

                <p id="successful-calls">0</p>

            </div>

            <div class="kpi-card">

                <h3>Failed Calls</h3>

                <p id="failed-calls">0</p>

            </div>

            <div class="kpi-card">

                <h3>Success Rate</h3>

                <p id="success-rate">0%</p>

            </div>

            <div class="kpi-card">

                <h3>Positive Interactions</h3>

                <p id="positive-interactions">0</p>

            </div>

            <div class="kpi-card">

                <h3>Negative Interactions</h3>

                <p id="negative-interactions">0</p>

            </div>

            <div class="kpi-card">

                <h3>Neutral Interactions</h3>

                <p id="neutral-interactions">0</p>

            </div>

            <div class="kpi-card">

                <h3>Positive Rate</h3>

                <p id="positive-rate">0%</p>

            </div>

            <div class="kpi-card">

                <h3>Avg Call Duration</h3>

                <p id="average-call-duration">0s</p>

            </div>

             <div class="kpi-card">

                <h3>KPI 1 Average</h3>

                <p id="kpi-average-1">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 2 Average</h3>

                <p id="kpi-average-2">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 3 Average</h3>

                <p id="kpi-average-3">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 4 Average</h3>

                <p id="kpi-average-4">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 5 Average</h3>

                <p id="kpi-average-5">0</p>

            </div>

             <div class="kpi-card">

                <h3>KPI 6 Average</h3>

                <p id="kpi-average-6">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 7 Average</h3>

                <p id="kpi-average-7">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 8 Average</h3>

                <p id="kpi-average-8">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 9 Average</h3>

                <p id="kpi-average-9">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 10 Average</h3>

                <p id="kpi-average-10">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 11 Average</h3>

                <p id="kpi-average-11">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 12 Average</h3>

                <p id="kpi-average-12">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 13 Average</h3>

                <p id="kpi-average-13">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 14 Average</h3>

                <p id="kpi-average-14">0</p>

            </div>

             <div class="kpi-card">

                <h3>KPI 15 Average</h3>

                <p id="kpi-average-15">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 16 Average</h3>

                <p id="kpi-average-16">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 17 Average</h3>

                <p id="kpi-average-17">0</p>

            </div>

            <div class="kpi-card">

                <h3>KPI 18 Average</h3>

                <p id="kpi-average-18">0</p>

            </div>



        </div>



        <div class="charts-section">

            <div class="chart-card">

                <h3>Call Volume Over Time</h3>

                <canvas id="callVolumeChart"></canvas>

            </div>

            <div class="chart-card">

                <h3>Sentiment Distribution</h3>

                <canvas id="sentimentChart"></canvas>

            </div>

        </div>



        <div class="calls-section">

            <h2>Recent Calls</h2>

            <div id="recent-calls-list">

                </div>

        </div>

    </div>



    <script>

        const socket = io();

        let callVolumeChart;

        let sentimentChart;



        socket.on('connect', () => {

            console.log('🔗 Connected to SocketIO');

        });



        socket.on('disconnect', () => {

            console.log('🔌 Disconnected from SocketIO');

        });



        socket.on('dashboard_data_update', (data) => {

            console.log('🔄 Dashboard data received:', data);

            updateKPIs(data);

            updateCharts(data);

            updateCallsList(data.recent_calls);

        });



        function updateKPIs(data) {

            document.getElementById('total-calls').textContent = data.total_calls;

            document.getElementById('successful-calls').textContent = data.successful_calls;

            document.getElementById('failed-calls').textContent = data.failed_calls;

            document.getElementById('success-rate').textContent = `${data.success_rate}%`;

            document.getElementById('positive-interactions').textContent = data.positive_interactions;

            document.getElementById('negative-interactions').textContent = data.negative_interactions;

            document.getElementById('neutral-interactions').textContent = data.neutral_interactions;

            document.getElementById('positive-rate').textContent = `${data.positive_rate}%`;

            document.getElementById('average-call-duration').textContent = `${data.average_call_duration}s`;



            // Update KPI averages

            for (let i = 1; i <= 18; i++) {

                const kpiId = `kpi-average-${i}`;

                if (document.getElementById(kpiId)) {

                    document.getElementById(kpiId).textContent = data.kpi_averages[`kpi_${i}_avg`] !== undefined ? data.kpi_averages[`kpi_${i}_avg`].toFixed(1) : 'N/A';

                }

            }

        }



        function updateCharts(data) {

            // Call Volume Chart

            const callVolumeCtx = document.getElementById('callVolumeChart').getContext('2d');

            if (callVolumeChart) {

                callVolumeChart.destroy();

            }

            callVolumeChart = new Chart(callVolumeCtx, {

                type: 'line',

                data: {

                    labels: data.call_volume_labels, // Assuming data will provide labels like ['10 AM', '11 AM']

                    datasets: [{

                        label: 'Call Volume',

                        data: data.call_volume_data, // Assuming data will provide [5, 10, 8]

                        borderColor: 'rgb(75, 192, 192)',

                        tension: 0.1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    scales: {

                        y: {

                            beginAtZero: true,

                            title: {

                                display: true,

                                text: 'Number of Calls'

                            }

                        },

                        x: {

                            title: {

                                display: true,

                                text: 'Time'

                            }

                        }

                    }

                }

            });



            // Sentiment Distribution Chart

            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');

            if (sentimentChart) {

                sentimentChart.destroy();

            }

            sentimentChart = new Chart(sentimentCtx, {

                type: 'pie',

                data: {

                    labels: ['Positive', 'Negative', 'Neutral'],

                    datasets: [{

                        data: [data.positive_interactions, data.negative_interactions, data.neutral_interactions],

                        backgroundColor: [

                            'rgba(40, 167, 69, 0.7)',  // Green

                            'rgba(220, 53, 69, 0.7)',   // Red

                            'rgba(108, 117, 125, 0.7)'  // Gray

                        ],

                        borderColor: [

                            'rgba(40, 167, 69, 1)',

                            'rgba(220, 53, 69, 1)',

                            'rgba(108, 117, 125, 1)'

                        ],

                        borderWidth: 1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: {

                        legend: {

                            position: 'top',

                        },

                        title: {

                            display: true,

                            text: 'Call Sentiment'

                        }

                    }

                }

            });

        }



        function updateCallsList(calls) {

            const recentCallsList = document.getElementById('recent-calls-list');

            recentCallsList.innerHTML = ''; // Clear existing list



            if (calls && calls.length > 0) {

                calls.forEach(call => {

                    const callItem = document.createElement('div');

                    callItem.classList.add('call-item');

                    

                    let sentimentClass = '';

                    if (call.sentiment === 'positive') {

                        sentimentClass = 'sentiment-positive';

                    } else if (call.sentiment === 'negative') {

                        sentimentClass = 'sentiment-negative';

                    } else {

                        sentimentClass = 'sentiment-neutral';

                    }



                    callItem.innerHTML = `

                        <div class="call-details">

                            <h4>Call ID: ${call.id || 'N/A'}</h4>

                            <p><strong>Transcript:</strong> ${call.transcript ? call.transcript.substring(0, 150) + '...' : 'N/A'}</p>

                            <p><strong>Duration:</strong> ${call.duration ? call.duration.toFixed(1) + 's' : 'N/A'}</p>

                            <p><strong>Timestamp:</strong> ${call.timestamp ? new Date(call.timestamp).toLocaleString() : 'N/A'}</p>

                        </div>

                        <div class="call-sentiment ${sentimentClass}">

                            ${call.sentiment ? call.sentiment.charAt(0).toUpperCase() + call.sentiment.slice(1) : 'N/A'}

                        </div>

                    `;

                    recentCallsList.appendChild(callItem);

                });

            } else {

                recentCallsList.innerHTML = '<p>No recent calls to display.</p>';

            }

        }



        // Initial load of stats and calls (assuming Flask provides initial data)

        fetch('/api/stats')

            .then(response => response.json())

            .then(data => {

                console.log('📊 Stats loaded:', data);

                updateKPIs(data);

                // Assuming data also contains call_volume_labels and call_volume_data for initial chart draw

                updateCharts(data);

            })

            .catch(error => console.error('❌ Error loading stats:', error));



        // Load recent calls

        fetch('/api/calls?limit=10')

            .then(response => response.json())

            .then(data => {

                console.log('📞 Calls loaded:', data.calls?.length || 0);

                updateCallsList(data.calls || []);

            })

            .catch(error => {

                console.error('❌ Error loading recent calls:', error);

                document.getElementById('recent-calls-list').innerHTML = '<p>Failed to load recent calls.</p>';

            });

    </script>

    <button id="chatbot-toggle-button">💬 Chat with Waste King</button>

    <div id="chatbot-widget-container">
        <div id="chatbot-header">
            Waste King Assistant
            <button id="chatbot-close-button">X</button>
        </div>
        <div id="chatbot-messages">
            <div class="chatbot-message chatbot-message-ai">Hello! How can I help you with Waste King services today?</div>
        </div>
        <div id="chatbot-input-area">
            <input type="text" id="chatbot-user-input" placeholder="Type your message...">
            <button id="chatbot-send-button">Send</button>
        </div>
    </div>
    <script>
        const chatbotContainer = document.getElementById('chatbot-widget-container');
        const chatbotToggleButton = document.getElementById('chatbot-toggle-button');
        const chatbotCloseButton = document.getElementById('chatbot-close-button');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotUserInput = document.getElementById('chatbot-user-input');
        const chatbotSendButton = document.getElementById('chatbot-send-button');

        // Toggle chatbot visibility
        chatbotToggleButton.addEventListener('click', () => {
            chatbotContainer.classList.toggle('open');
            // Hide/show the toggle button based on widget state
            chatbotToggleButton.style.display = chatbotContainer.classList.contains('open') ? 'none' : 'block';
            if (chatbotContainer.classList.contains('open')) {
                chatbotUserInput.focus(); // Focus on input when opened
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight; // Scroll to bottom
            }
        });

        chatbotCloseButton.addEventListener('click', () => {
            chatbotContainer.classList.remove('open');
            chatbotToggleButton.style.display = 'block'; // Show toggle button when closed
        });

        function appendChatMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message', `chatbot-message-${sender}`);
            messageDiv.textContent = text;
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight; // Scroll to bottom
        }

        async function sendChatMessage() {
            const message = chatbotUserInput.value.trim();
            if (message === '') return;

            appendChatMessage(message, 'user');
            chatbotUserInput.value = ''; // Clear input

            try {
                const response = await fetch('/api/chat', { // Sends to the new API endpoint in app.py
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                const data = await response.json();
                if (data.response) {
                    appendChatMessage(data.response, 'ai');
                } else {
                    appendChatMessage('Error: ' + (data.error || 'Could not get AI response.'), 'ai');
                }
            } catch (error) {
                console.error('Error sending message to chatbot API:', error);
                appendChatMessage('An error occurred. Please try again.', 'ai');
            }
        }

        chatbotSendButton.addEventListener('click', sendChatMessage);
        chatbotUserInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Initial button visibility (hide button if widget is forced open on load, though it starts closed)
        if (chatbotContainer.classList.contains('open')) {
            chatbotToggleButton.style.display = 'none';
        } else {
            chatbotToggleButton.style.display = 'block';
        }

    </script>
    </body>

</html>
